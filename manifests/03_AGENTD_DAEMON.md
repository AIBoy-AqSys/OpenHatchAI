# 03_AGENTD_DAEMON.md（常駐デーモン）
責務種別: `BUILD + RUNTIME_POLICY`

## 何を行うのか
- GitHub Webhook を受ける常駐デーモン（agentd）を構成する
- Issueコメント内の起動指示（`@agent run:`）を検出し、ジョブ化する
- 複数プロジェクトを扱えるよう、リポジトリ情報をレジストリ形式で管理する
- 署名検証により正当なWebhookのみ受理する
- 自律修正/検証ループ・ブラウザ検証・PR化を含む外部サーバ実行の基盤を提供する
- AI Provider（`codex` / `claude` / `gemini`）を切替可能にする
- 実行ログとジョブ管理を分離して保持する
- 常駐化し、再起動後も運用継続できるようにする

## 構築時に行うこと（BUILD）
- agentd の配置先・実行ユーザー・常駐方法を決める
- Webhook受信・署名検証・ジョブキュー化・ログ保存が可能な状態を導入する
- 対象リポジトリのレジストリ管理方式を配置する
- ブラウザ検証を使える基盤を導入し、agentd から呼べる状態を確認する
- Provider切替設定（`codex` / `claude` / `gemini`）を `.env` で読み取れるようにする
- 進捗通知（開始/中間/完了/エラー）をIssueへ送るための連携前提を整える
- `12_SERVER_AI_INSTRUCTIONS.md` を agentd 実行時の基盤指示書として参照できる場所へ配置する

## 常駐後に行うこと（RUNTIME_POLICY）
- Webhookイベントから実行対象Issue/PRと対象リポジトリを解決する
- 実行前に対象リポジトリの `main` を最新化する
- 最新化した `main` を基準に作業ブランチを作成する
- Issue解決に向けて自律的に修正と検証を繰り返す実行ループを運用する
- コード検証に加え、ブラウザ検証を積極的に使って再現確認・修正確認・解決判断を行う
- 指示または既定設定に応じて `codex` / `claude` / `gemini` を選択・切替して実行する
- 成功時はコミット→push→PR作成まで流す
- 停止条件到達時は到達点・未解決点・次の打ち手をIssueへ報告する

## 重要な役割分担
- agentdは「起動・`main` 最新化・自律修正/検証ループ・ブラウザ検証・PR化」まで担当
- 品質判定と本番反映の最終判断はGitHubゲート側に委ねる
