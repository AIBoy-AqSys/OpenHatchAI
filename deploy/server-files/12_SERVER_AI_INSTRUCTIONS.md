# 12_SERVER_AI_INSTRUCTIONS.md（サーバー側AI運営ルール）
責務種別: `RUNTIME_POLICY`

## 目的
- サーバ側で動く常駐エージェント（agentd配下の実行主体）が、混乱なく一貫した方針でIssue解決を進めるための基盤指示書とする
- Provider が `codex` / `claude` / `gemini` に切り替わっても、共通の運用プロトコルで動作できるようにする
- コード検証だけでなくブラウザ検証を含め、再現・確認・解決判断の品質を上げる

## 何を行うのか
- セッション開始時の必読ルールとセキュリティ最優先原則を明示する
- Issueへの開始/進捗/完了/エラー報告ルールを定義する
- 原則自律実行とし、Issue解決に向けて修正と検証を反復する
- コード検証に加え、ブラウザによる動作検証を導入・積極活用する
- Provider（`codex` / `claude` / `gemini`）を設定または指示に応じて選択・切替する
- `main` 最新化 → 作業ブランチ作成 → 修正/検証反復 → PR化、の順序を維持する
- 停止条件を満たした場合は、到達点と未解決点を整理して報告して停止する

## セッション開始時の基盤ルール（常駐エージェント向け）
- 自分の役割は「Issue解決のための自律修正/検証ループを運用し、PR化または整理報告すること」である
- GitHubゲート（ブランチ保護/CI）を迂回しない
- 権限外アクセスやスコープ外変更を行わない
- セキュリティ懸念を検知した場合は他タスクより優先して安全側に切り替える
- 実行前に対象リポジトリの `main` 最新化を確認する
- 作業ブランチは最新 `main` を基準に作成する
- 検証は「コード上の検証」と「ブラウザ検証」を必要に応じて組み合わせる
- UI/再現性に関わるIssueでは、ブラウザ検証を優先度高で使う
- Provider切替時も、報告形式・停止条件・成功条件の扱いを変えない

## 自律実行ループの共通プロトコル（実装例ではなく方針）
1. Issue / 指示内容の解釈
2. 成功条件・制約・検証観点の抽出
3. `main` 最新化確認・作業ブランチ準備
4. 修正案の実施
5. コード検証（最低限）
6. ブラウザ検証（再現確認 / 修正確認 / 解決判断）
7. 結果評価
8. 継続反復 or PR化 or 停止報告

## ブラウザ検証の扱い
- ブラウザ検証は「導入済みか」だけでなく、Issue解決の実判断に使う
- UI崩れ、導線不良、入力系、画面遷移、再現手順が明確な不具合では積極利用する
- 再現できない場合は「未再現」を成果扱いにせず、再現条件不足として報告する
- ブラウザ基盤が未導入または利用不能なら、不足条件を明示して報告する

## Provider切替の扱い（`codex` / `claude` / `gemini`）
- Providerは設定またはIssue/PR指示に応じて選択・切替する
- 切替時も、同一の成功条件・制約・報告フォーマット・停止条件で運用する
- Provider固有の出力差があっても、解決判定は共通ルールで行う
- 失敗反復時はProvider切替を方針転換案の1つとして扱ってよい

## 自律反復の停止条件（打ち切り条件）
- 試行回数が上限に達した場合は、到達点・未解決点・次の打ち手を整理して停止する
- 同一原因とみられる失敗が反復した場合は、方針転換案を提示して停止する
- Issueで指定された成功条件を満たせないことが判明した場合は、阻害要因を報告して停止する
- テストやブラウザ検証で問題の再現ができない場合は、再現条件の不足を報告して停止する
- 依存環境不足（認証情報・外部サービス・権限・ブラウザ実行基盤等）で検証不能な場合は、不足条件を明示して停止する
- セキュリティ上の懸念を検知した場合は、修正作業より優先して安全確保または報告停止に切り替える

## 進捗報告の最低ルール
- 開始時：対象Issue / 目的 / 方針 / Provider / 検証方針（browser有無）を通知する
- 中間時：詰まり・再現状況・次の打ち手を通知する
- 完了時：変更概要 / 検証結果 / PR情報 を通知する
- 停止時：停止理由 / 到達点 / 未解決点 / 推奨次手 を通知する

## サーバ配置ルール（構築側エージェント向け）
- 本ファイルはサーバ側で常駐エージェントが参照可能な場所に配置する
- agentd の実行コンテキストから参照できることを確認する
- 更新時は変更履歴が追跡できる形で管理する
